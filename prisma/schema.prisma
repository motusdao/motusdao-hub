generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model contactMessage {
  id        String   @id @default(cuid())
  name      String
  email     String
  message   String
  userId    String?
  createdAt DateTime @default(now())
  user      user?    @relation(fields: [userId], references: [id])

  @@map("contact_messages")
}

model course {
  id          String        @id
  title       String
  slug        String        @unique
  summary     String
  description String?
  imageUrl    String?
  isPublished Boolean       @default(false)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime
  enrollments enrollment[]
  modules     module[]

  @@map("courses")
}

model enrollment {
  id        String   @id
  userId    String
  courseId  String
  progress  Int      @default(0)
  completed Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime
  course    course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  user      user     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
  @@map("enrollments")
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model journalEntry {
  id        String   @id @default(cuid())
  userId    String
  content   String
  mood      String?
  tags      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      user     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("journal_entries")
}

model module {
  id          String   @id
  courseId    String
  title       String
  summary     String?
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime
  course      course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  lessons     lesson[]

  @@unique([courseId, order])
  @@map("modules")
}

model lesson {
  id          String   @id
  moduleId    String
  title       String
  slug        String
  summary     String?
  contentMDX  String?
  order       Int      @default(0)
  duration    Int?
  isPublished Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime
  module      module   @relation(fields: [moduleId], references: [id], onDelete: Cascade)

  @@unique([moduleId, slug])
  @@map("lessons")
}

model match {
  id         String      @id @default(cuid())
  userId     String
  psmId      String
  status     MatchStatus @default(active)
  matchedAt  DateTime    @default(now())
  endedAt    DateTime?
  reason     String?
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt
  psm        user        @relation("matches_psmIdTousers", fields: [psmId], references: [id], onDelete: Cascade)
  user       user        @relation("matches_userIdTousers", fields: [userId], references: [id], onDelete: Cascade)
  sessions   session[]

  @@map("matches")
  @@unique([userId, psmId])
  @@index([psmId, status])
  @@index([userId, status])
}

model PatientProfile {
  id                    String   @id @default(cuid())
  userId                String   @unique
  tipoAtencion          String
  problematica          String
  preferenciaAsignacion String
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  user                  user     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("patient_profiles")
}

model paymentLog {
  id                                   String             @id @default(cuid())
  fromUserId                           String
  toUserId                             String?
  destination                          PaymentDestination
  destinationAddress                   String
  amount                               String
  currency                             String
  transactionHash                      String             @unique
  explorerUrl                          String?
  notes                                String?
  createdAt                            DateTime           @default(now())
  fromUser                             user               @relation("payment_logs_fromUserIdTousers", fields: [fromUserId], references: [id], onDelete: Cascade)
  toUser                               user?              @relation("payment_logs_toUserIdTousers", fields: [toUserId], references: [id])

  @@map("payment_logs")
  @@index([destination])
  @@index([fromUserId, createdAt])
  @@index([toUserId, createdAt])
}

model PaymentPreference {
  id                 String             @id @default(cuid())
  userId             String             @unique
  defaultDestination PaymentDestination @default(own_wallet)
  createdAt          DateTime           @default(now())
  updatedAt          DateTime          @updatedAt
  user               user               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("payment_preferences")
}

model profile {
  id              String   @id @default(cuid())
  userId          String   @unique
  nombre          String
  apellido        String
  telefono        String
  fechaNacimiento DateTime
  ciudad          String
  pais            String
  avatarUrl       String?
  bio             String?
  language        String   @default("es")
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  user            user     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("profiles")
}

model PSMProfile {
  id                     String   @id @default(cuid())
  userId                 String   @unique
  cedulaProfesional      String
  formacionAcademica     String
  experienciaAnios       Int
  biografia              String?
  especialidades         String
  participaSupervision   Boolean  @default(false)
  participaCursos        Boolean  @default(false)
  participaInvestigacion Boolean  @default(false)
  participaComunidad     Boolean  @default(false)
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt
  user                   user     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("psm_profiles")
}

model session {
  id                           String        @id @default(cuid())
  userId                       String
  psmId                        String
  matchId                      String?
  status                       SessionStatus @default(requested)
  mode                         SessionMode   @default(video_external)
  externalUrl                  String
  requestedAt                  DateTime      @default(now())
  acceptedAt                   DateTime?
  startedAt                    DateTime?
  completedAt                  DateTime?
  cancelledAt                  DateTime?
  cancelReason                 String?
  createdAt                    DateTime      @default(now())
  updatedAt                    DateTime      @updatedAt
  match                       match?       @relation(fields: [matchId], references: [id])
  psm                         user         @relation("sessions_psmIdTousers", fields: [psmId], references: [id], onDelete: Cascade)
  user                        user         @relation("sessions_userIdTousers", fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
  @@index([psmId, status])
  @@index([userId, status])
}

model user {
  id                                          String               @id @default(cuid())
  role                                        Role                 @default(usuario)
  email                                       String               @unique
  privyId                                     String?              @unique
  createdAt                                   DateTime             @default(now())
  updatedAt                                   DateTime             @updatedAt
  eoaAddress                                  String               @unique
  smartWalletAddress                          String?              @unique
  registrationCompleted                       Boolean              @default(false)
  deletedAt                                   DateTime?
  restoredAt                                  DateTime?
  contactMessages                             contactMessage[]
  enrollments                                 enrollment[]
  journalEntries                              journalEntry[]
  psmMatches                                  match[]              @relation("matches_psmIdTousers")
  userMatches                                 match[]              @relation("matches_userIdTousers")
  patient                                     PatientProfile?
  paymentsSent                                paymentLog[]         @relation("payment_logs_fromUserIdTousers")
  paymentsReceived                            paymentLog[]         @relation("payment_logs_toUserIdTousers")
  paymentPreference                           PaymentPreference?
  profile                                     profile?
  psm                                         PSMProfile?
  sessionsAsPSM                               session[]            @relation("sessions_psmIdTousers")
  sessionsAsUser                              session[]            @relation("sessions_userIdTousers")

  @@map("users")
}

enum MatchStatus {
  active
  paused
  ended
}

enum PaymentDestination {
  own_wallet
  matched_psm
  dao_treasury
}

enum Role {
  usuario
  psm
  admin
}

enum SessionMode {
  video_external
}

enum SessionStatus {
  requested
  accepted
  completed
  cancelled
}
